generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ======================================
// ENUMs for Data Integrity
// ======================================

enum UserRole {
  HOST
  ADMIN
}

enum PlatformType {
  SHOPEE_LIVE
  TIKTOK_LIVE
  TOKOPEDIA_PLAY
  LAZADA_LIVE
}

enum Store {
  GROGLO_BEAUTY
  TKIS_HOME_LIVING
  PET_JOY
  TIMELESS_BEAUTY
  YK_DESIGN
}

// ======================================
// MASTER TABLES
// ======================================

// Model untuk Host (User)
model User {
  id           Int        @id @default(autoincrement())
  username     String     @unique
  password     String     // Tentu saja, di-hash
  displayName  String
  role         UserRole   @default(HOST) // HOST atau ADMIN
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  // Notification fields
  pushSubscription         String?  @map("push_subscription") @db.Text // JSON string of push subscription
  notificationPreferences  String?  @map("notification_preferences") @db.Text // JSON string of preferences

  // Relasi: Satu host memiliki banyak jadwal
  schedules    Schedule[]

  @@map("users")
}

// Model "Kamus" untuk semua produk
model Product {
  id           Int      @id @default(autoincrement())
  sku          String   @unique // SKU (Stock Keeping Unit) sangat penting
  name         String
  defaultPrice Decimal  @db.Decimal(12, 2) @map("default_price") // Harga normal
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relasi: Produk ini bisa ada di banyak jadwal
  schedules    ScheduleProduct[]

  @@map("products")
}

// Model "Kamus" untuk semua voucher
model Voucher {
  id          Int      @id @default(autoincrement())
  code        String   @unique // Kode voucher, misal "GGMG11"
  description String
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relasi: Voucher ini bisa ada di banyak jadwal
  schedules   ScheduleVoucher[]

  @@map("vouchers")
}


// ======================================
// TRANSACTION & DETAIL TABLES
// ======================================

// Model untuk Jadwal (Briefing Utama)
model Schedule {
  id           String     @id @default(cuid())
  hostId       Int        @map("host_id")
  title        String     // Misal: "Flash Sale Groglo 11.11!"
  platform     PlatformType
  storeName    Store      @map("store_name")
  scheduledAt  DateTime   @map("scheduled_at") // Kapan siaran dimulai
  salesTarget  Decimal    @db.Decimal(12, 2) @map("sales_target")
  
  acknowledgedAt DateTime?  @map("acknowledged_at")
  
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  // Relasi: Jadwal ini milik satu Host
  host         User       @relation(fields: [hostId], references: [id])

  // Relasi: Jadwal ini memiliki banyak...
  products     ScheduleProduct[]
  vouchers     ScheduleVoucher[]
  talkingPoints TalkingPoint[]

  // Index untuk query performa tinggi
  @@index([hostId])
  @@index([scheduledAt])

  @@map("schedules")
}

// Model untuk Talking Points (One-to-Many)
model TalkingPoint {
  id         Int      @id @default(autoincrement())
  scheduleId String   @map("schedule_id")
  text       String   // Teks dari talking point
  order      Int      // Untuk menjaga urutan (1, 2, 3, ...)
  
  // Relasi: Poin ini milik satu jadwal
  schedule   Schedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)

  // Index untuk query performa tinggi
  @@index([scheduleId])
  
  @@map("talking_points")
}


// ======================================
// JOIN TABLES (Many-to-Many)
// ======================================

// Join table untuk Schedules dan Products
model ScheduleProduct {
  scheduleId  String   @map("schedule_id")
  productId   Int      @map("product_id")
  
  // HARGA PROMO ADA DI SINI!
  // Ini adalah harga spesial produk HANYA untuk siaran ini.
  promoPrice  Decimal  @db.Decimal(12, 2) @map("promo_price")

  // Relasi
  schedule    Schedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  product     Product  @relation(fields: [productId], references: [id], onDelete: Restrict)

  // Primary key gabungan
  @@id([scheduleId, productId])
  // Index untuk query
  @@index([scheduleId])
  @@index([productId])
  
  @@map("schedule_products")
}

// Join table untuk Schedules dan Vouchers
model ScheduleVoucher {
  scheduleId  String   @map("schedule_id")
  voucherId   Int      @map("voucher_id")

  // Relasi
  schedule    Schedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  voucher     Voucher  @relation(fields: [voucherId], references: [id], onDelete: Restrict)

  // Primary key gabungan
  @@id([scheduleId, voucherId])
  // Index untuk query
  @@index([scheduleId])
  @@index([voucherId])

  @@map("schedule_vouchers")
}